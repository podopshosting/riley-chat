<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riley CRM Dashboard - Panda Exteriors</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h1 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-item {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            color: #667eea;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .nav-item.hidden {
            display: none;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .kanban-column {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            min-height: 400px;
        }
        
        .column-header {
            font-weight: 600;
            padding: 12px;
            margin: -20px -20px 20px -20px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        
        .conversation-card {
            background: white;
            border: 1px solid #ddd;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .conversation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .conversation-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .kanban-column.drag-over {
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed #667eea;
        }
        
        .customer-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
        }
        
        .phone {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .conversation-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover { color: #000; }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .message-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .message-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .message-user {
            background: #e3f2fd;
            margin-left: 20px;
        }
        
        .message-bot {
            background: #f3e5f5;
            margin-right: 20px;
        }
        
        .message-admin {
            background: #fff3cd;
            margin-right: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .agent-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .agent-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            margin: 2px;
            display: inline-block;
        }
        
        .role-super-admin { background: #dc3545; color: white; }
        .role-admin { background: #ffc107; color: #333; }
        .role-agent { background: #28a745; color: white; }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .roles-permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 15px 0;
        }
        
        .checkbox-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        
        .checkbox-group h5 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .checkbox-group label {
            display: block;
            margin: 8px 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }
        
        .lsa-tab-content {
            margin-top: 20px;
        }
        
        .lsa-leads-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .lsa-leads-table th,
        .lsa-leads-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .lsa-leads-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .nav { flex-direction: column; }
            .kanban-board { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="riley-api.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-form">
            <h1>ü§ñ Riley CRM</h1>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="login-email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="login-password" placeholder="Enter your password">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
            <div id="login-error" class="error-message"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="container">
        <div class="header">
            <div>
                <h1>ü§ñ Riley CRM Dashboard</h1>
                <p>AI-Powered SMS & Lead Management System</p>
            </div>
            <div class="user-info">
                <span id="current-user">Welcome</span>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="nav" id="main-nav">
            <div class="nav-item active" onclick="showPage('kanban')" data-permission="conversations">üìã Conversations</div>
            <div class="nav-item" onclick="showPage('analytics')" data-permission="analytics">üìà Analytics</div>
            <div class="nav-item" onclick="showPage('contacts')" data-permission="conversations">üë• Contacts</div>
            <div class="nav-item" onclick="showPage('google-lsa')" data-permission="lsa">üéØ Google LSA</div>
            <div class="nav-item" onclick="showPage('admin')" data-permission="admin">‚öôÔ∏è Admin</div>
            <div class="nav-item" onclick="refreshData()">üîÑ Refresh</div>
        </div>

        <!-- Kanban Page -->
        <div id="kanban" class="page active">
            <div class="kanban-board">
                <div class="kanban-column" data-status="active">
                    <div class="column-header" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                        New Leads (<span id="active-count">0</span>)
                    </div>
                    <div id="active-conversations-list">Loading...</div>
                </div>
                <div class="kanban-column" data-status="contacted">
                    <div class="column-header" style="background: linear-gradient(135deg, #fff3e0, #ffcc02);">
                        Contacted (<span id="contacted-count">0</span>)
                    </div>
                    <div id="contacted-conversations-list">Loading...</div>
                </div>
                <div class="kanban-column" data-status="qualified">
                    <div class="column-header" style="background: linear-gradient(135deg, #e8f5e8, #4caf50);">
                        Qualified (<span id="qualified-count">0</span>)
                    </div>
                    <div id="qualified-conversations-list">Loading...</div>
                </div>
                <div class="kanban-column" data-status="converted">
                    <div class="column-header" style="background: linear-gradient(135deg, #f3e5f5, #9c27b0);">
                        Converted (<span id="converted-count">0</span>)
                    </div>
                    <div id="converted-conversations-list">Loading...</div>
                </div>
                <div class="kanban-column" data-status="archived">
                    <div class="column-header" style="background: linear-gradient(135deg, #f5f5f5, #9e9e9e);">
                        Archived (<span id="archived-count">0</span>)
                    </div>
                    <div id="archived-conversations-list">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="admin-section">
                <h3>üìà Analytics Dashboard</h3>
                <div class="agents-grid">
                    <div class="agent-card">
                        <strong id="analytics-total">0</strong><br>
                        <small>Total Conversations</small>
                    </div>
                    <div class="agent-card">
                        <strong id="analytics-active">0</strong><br>
                        <small>Active Conversations</small>
                    </div>
                    <div class="agent-card">
                        <strong id="analytics-converted">0</strong><br>
                        <small>Converted Leads</small>
                    </div>
                    <div class="agent-card">
                        <strong id="analytics-rate">0%</strong><br>
                        <small>Conversion Rate</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Page -->
        <div id="contacts" class="page">
            <div class="admin-section">
                <h3>üë• Contact Profiles</h3>
                <div class="form-group" style="max-width: 400px;">
                    <input type="text" id="contact-search" placeholder="Search contacts..." onkeyup="searchContacts()">
                </div>
                <div id="contacts-grid" class="agents-grid">
                    <!-- Contacts will be populated here -->
                </div>
            </div>
        </div>

        <!-- Google LSA Page -->
        <div id="google-lsa" class="page">
            <div class="admin-section">
                <h3>üéØ Google LSA Leads Dashboard</h3>
                <div id="lsa-status" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Status:</strong> <span id="lsa-connection-status">Loading LSA data...</span>
                </div>
                
                <div class="nav" style="margin-bottom: 20px;" id="lsa-tabs">
                    <div class="nav-item active" onclick="showLSATab('rollup')">üìä Roll Up</div>
                    <div class="nav-item" onclick="showLSATab('maryland')">üè† Maryland</div>
                    <div class="nav-item" onclick="showLSATab('florida')">üå¥ Florida</div>
                    <div class="nav-item" onclick="showLSATab('pennsylvania')">üèõÔ∏è Pennsylvania</div>
                    <div class="nav-item" onclick="showLSATab('virginia')">‚õ∞Ô∏è Virginia</div>
                    <div class="nav-item" onclick="showLSATab('north-carolina')">üå≤ North Carolina</div>
                </div>
                
                <!-- Roll Up Tab -->
                <div id="lsa-rollup" class="lsa-tab-content">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong id="rollup-total-leads">247</strong><br>
                            <small>Total LSA Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong id="rollup-charged-leads">189</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong id="rollup-locations">8</strong><br>
                            <small>Active Locations</small>
                        </div>
                        <div class="agent-card">
                            <strong id="rollup-conversion-rate">23%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4>Recent LSA Leads</h4>
                        <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                            <table class="lsa-leads-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Phone</th>
                                        <th>Service</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Call Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="rollup-leads-tbody">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading LSA leads...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Maryland Tab -->
                <div id="lsa-maryland" class="lsa-tab-content" style="display: none;">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong>67</strong><br>
                            <small>Total Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>52</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>Laurel, Marlton</strong><br>
                            <small>Active Cities</small>
                        </div>
                        <div class="agent-card">
                            <strong>28%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4>Maryland LSA Leads</h4>
                        <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                            <table class="lsa-leads-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Phone</th>
                                        <th>Service</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Call Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="maryland-leads-tbody">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading Maryland leads...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Florida Tab -->
                <div id="lsa-florida" class="lsa-tab-content" style="display: none;">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong>89</strong><br>
                            <small>Total Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>71</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>Tampa</strong><br>
                            <small>Active Cities</small>
                        </div>
                        <div class="agent-card">
                            <strong>31%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                </div>
                
                <!-- Pennsylvania Tab -->
                <div id="lsa-pennsylvania" class="lsa-tab-content" style="display: none;">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong>45</strong><br>
                            <small>Total Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>34</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>King of Prussia</strong><br>
                            <small>Active Cities</small>
                        </div>
                        <div class="agent-card">
                            <strong>19%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                </div>
                
                <!-- Virginia Tab -->
                <div id="lsa-virginia" class="lsa-tab-content" style="display: none;">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong>28</strong><br>
                            <small>Total Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>21</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>Reston</strong><br>
                            <small>Active Cities</small>
                        </div>
                        <div class="agent-card">
                            <strong>15%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                </div>
                
                <!-- North Carolina Tab -->
                <div id="lsa-north-carolina" class="lsa-tab-content" style="display: none;">
                    <div class="agents-grid">
                        <div class="agent-card">
                            <strong>18</strong><br>
                            <small>Total Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>11</strong><br>
                            <small>Charged Leads</small>
                        </div>
                        <div class="agent-card">
                            <strong>Charlotte, Dover</strong><br>
                            <small>Active Cities</small>
                        </div>
                        <div class="agent-card">
                            <strong>22%</strong><br>
                            <small>Conversion Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin" class="page">
            <div class="admin-section">
                <h3>üë• Agent Management</h3>
                <p style="margin-bottom: 20px; color: #666;">Agents, Admins, and Super Admins who can handle conversations</p>
                <div class="agents-grid" id="agents-grid">
                    <!-- Agents will be populated here -->
                </div>
            </div>
            
            <div class="admin-section user-management" id="user-management">
                <h3>üë§ User Management</h3>
                <div class="form-group">
                    <div class="form-grid">
                        <div>
                            <label>Full Name:</label>
                            <input type="text" id="new-user-name" placeholder="Enter full name">
                        </div>
                        <div>
                            <label>Email:</label>
                            <input type="email" id="new-user-email" placeholder="Enter email address">
                        </div>
                        <div>
                            <label>Password:</label>
                            <input type="password" id="new-user-password" placeholder="Enter password">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="addUser()">Add User</button>
                        </div>
                    </div>
                </div>
                
                <div class="roles-permissions-grid">
                    <div class="checkbox-group">
                        <h5>Roles:</h5>
                        <label><input type="checkbox" id="role-super-admin"> Super Admin</label>
                        <label><input type="checkbox" id="role-admin"> Admin</label>
                        <label><input type="checkbox" id="role-agent" checked> Agent</label>
                    </div>
                    <div class="checkbox-group">
                        <h5>Tab Permissions:</h5>
                        <label><input type="checkbox" id="perm-conversations" checked> Conversations</label>
                        <label><input type="checkbox" id="perm-analytics"> Analytics</label>
                        <label><input type="checkbox" id="perm-lsa"> Google LSA</label>
                        <label><input type="checkbox" id="perm-admin"> Admin</label>
                    </div>
                </div>
                
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Permissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Conversation Modal -->
    <div id="conversationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">Conversation Details</h3>
            
            <div class="form-group">
                <label>Customer Name:</label>
                <input type="text" id="modal-name" />
            </div>
            
            <div class="form-group">
                <label>Phone:</label>
                <input type="text" id="modal-phone" readonly />
            </div>
            
            <div class="form-group">
                <label>Lead Status:</label>
                <select id="modal-status">
                    <option value="active">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                    <option value="converted">Converted</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Assigned To:</label>
                <select id="modal-assigned">
                    <option value="Riley">Riley (AI Bot)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Notes:</label>
                <textarea id="modal-notes" placeholder="Add notes about this contact..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Message History:</label>
                <div id="modal-messages" class="message-history">
                    Loading messages...
                </div>
            </div>
            
            <div class="conversation-actions">
                <button class="btn btn-primary" onclick="saveContact()">Save Changes</button>
                <button class="btn btn-success" onclick="takeOverConversation()">Take Over</button>
                <button class="btn btn-warning" onclick="archiveConversation()">Archive</button>
                <button class="btn btn-danger" onclick="deleteConversation()">Delete</button>
                <input type="text" id="admin-message" placeholder="Send message to customer..." style="width: 50%; margin-right: 10px;" onkeypress="handleMessageKeyPress(event)">
                <button class="btn btn-warning" onclick="sendAdminMessage()">Send SMS</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditUserModal()">&times;</span>
            <h3>Edit User</h3>
            
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="edit-user-name" />
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="edit-user-email" />
            </div>
            
            <div class="form-group">
                <label>New Password (leave blank to keep current):</label>
                <input type="password" id="edit-user-password" />
            </div>
            
            <div class="roles-permissions-grid">
                <div class="checkbox-group">
                    <h5>Roles:</h5>
                    <label><input type="checkbox" id="edit-role-super-admin"> Super Admin</label>
                    <label><input type="checkbox" id="edit-role-admin"> Admin</label>
                    <label><input type="checkbox" id="edit-role-agent"> Agent</label>
                </div>
                <div class="checkbox-group">
                    <h5>Tab Permissions:</h5>
                    <label><input type="checkbox" id="edit-perm-conversations"> Conversations</label>
                    <label><input type="checkbox" id="edit-perm-analytics"> Analytics</label>
                    <label><input type="checkbox" id="edit-perm-lsa"> Google LSA</label>
                    <label><input type="checkbox" id="edit-perm-admin"> Admin</label>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Session Management
        let sessionTimeout;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
        
        function startSessionTimer() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                alert('Session expired. Please log in again.');
                logout();
            }, SESSION_DURATION);
        }
        
        function resetSessionTimer() {
            startSessionTimer();
            localStorage.setItem('lastActivity', Date.now());
        }
        
        // Reset timer on user activity
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);
        document.addEventListener('scroll', resetSessionTimer);
        
        // Global variables
        let conversations = [];
        let agents = ['Riley'];
        let currentUser = null;
        let contacts = {};
        let users = {};
        
        // Load persistent data
        function loadPersistentData() {
            const savedAgents = localStorage.getItem('rileyAgents');
            if (savedAgents) {
                agents = JSON.parse(savedAgents);
            }
            
            const savedUsers = localStorage.getItem('rileyUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                // Initialize with default admin (update credentials on first login)
                users = {
                    'admin@example.com': {
                        name: 'Admin User',
                        email: 'admin@example.com',
                        password: 'CHANGE_ME_ON_FIRST_LOGIN',
                        roles: ['Super Admin'],
                        permissions: ['conversations', 'analytics', 'lsa', 'admin'],
                        conversationCount: 0
                    }
                };
                localStorage.setItem('rileyUsers', JSON.stringify(users));
            }
            
            const savedContacts = localStorage.getItem('rileyContacts');
            if (savedContacts) {
                contacts = JSON.parse(savedContacts);
            }
            
            const savedConversations = localStorage.getItem('rileyConversations');
            if (savedConversations) {
                conversations = JSON.parse(savedConversations);
            }
        }
        
        function savePersistentData() {
            localStorage.setItem('rileyAgents', JSON.stringify(agents));
            localStorage.setItem('rileyUsers', JSON.stringify(users));
            localStorage.setItem('rileyContacts', JSON.stringify(contacts));
            localStorage.setItem('rileyConversations', JSON.stringify(conversations));
        }
        
        // Check session on page load
        function checkSession() {
            const user = localStorage.getItem('currentUser');
            const lastActivity = localStorage.getItem('lastActivity');
            
            if (user && lastActivity) {
                const timeSinceActivity = Date.now() - parseInt(lastActivity);
                if (timeSinceActivity < SESSION_DURATION) {
                    // Valid session, auto-login
                    const userData = JSON.parse(user);
                    currentUser = userData;
                    document.getElementById('current-user').textContent = `Welcome, ${userData.name}`;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-dashboard').style.display = 'block';
                    loadData();
                    updateNavPermissions();
                    startSessionTimer();
                    return true;
                }
            }
            return false;
        }
        
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            loadPersistentData();
            
            if (users[email] && users[email].password === password) {
                currentUser = {
                    email: email,
                    name: users[email].name,
                    roles: users[email].roles,
                    permissions: users[email].permissions
                };
                
                // Store session
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('lastActivity', Date.now());
                
                document.getElementById('current-user').textContent = `Welcome, ${currentUser.name}`;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                
                loadData();
                updateNavPermissions();
                startSessionTimer();
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'Invalid email or password';
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('lastActivity');
            clearTimeout(sessionTimeout);
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }
        
        function hasPermission(permission) {
            return currentUser && currentUser.permissions.includes(permission);
        }
        
        function updateNavPermissions() {
            console.log('Current user permissions:', currentUser ? currentUser.permissions : 'No user');
            const navItems = document.querySelectorAll('.nav-item[data-permission]');
            navItems.forEach(item => {
                const permission = item.getAttribute('data-permission');
                console.log('Checking permission:', permission, 'Has permission:', hasPermission(permission));
                if (!hasPermission(permission)) {
                    item.classList.add('hidden');
                } else {
                    item.classList.remove('hidden');
                }
            });
        }
        
        let editingUserEmail = null;
        
        function editUser(email) {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin permissions required.');
                return;
            }
            
            const user = users[email];
            if (!user) return;
            
            editingUserEmail = email;
            
            // Populate form
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-password').value = '';
            
            // Set roles
            document.getElementById('edit-role-super-admin').checked = user.roles.includes('Super Admin');
            document.getElementById('edit-role-admin').checked = user.roles.includes('Admin');
            document.getElementById('edit-role-agent').checked = user.roles.includes('Agent');
            
            // Set permissions
            document.getElementById('edit-perm-conversations').checked = user.permissions.includes('conversations');
            document.getElementById('edit-perm-analytics').checked = user.permissions.includes('analytics');
            document.getElementById('edit-perm-lsa').checked = user.permissions.includes('lsa');
            document.getElementById('edit-perm-admin').checked = user.permissions.includes('admin');
            
            document.getElementById('editUserModal').style.display = 'block';
        }
        
        function saveUserEdit() {
            const name = document.getElementById('edit-user-name').value;
            const email = document.getElementById('edit-user-email').value;
            const password = document.getElementById('edit-user-password').value;
            
            if (!name || !email) {
                alert('Name and email are required');
                return;
            }
            
            // Check if email changed and already exists
            if (email !== editingUserEmail && users[email]) {
                alert('User with this email already exists');
                return;
            }
            
            // Get roles and permissions
            const roles = [];
            if (document.getElementById('edit-role-super-admin').checked) roles.push('Super Admin');
            if (document.getElementById('edit-role-admin').checked) roles.push('Admin');
            if (document.getElementById('edit-role-agent').checked) roles.push('Agent');
            
            const permissions = [];
            if (document.getElementById('edit-perm-conversations').checked) permissions.push('conversations');
            if (document.getElementById('edit-perm-analytics').checked) permissions.push('analytics');
            if (document.getElementById('edit-perm-lsa').checked) permissions.push('lsa');
            if (document.getElementById('edit-perm-admin').checked) permissions.push('admin');
            
            // Update user
            const user = users[editingUserEmail];
            user.name = name;
            user.roles = roles;
            user.permissions = permissions;
            
            // Update password if provided
            if (password.trim()) {
                user.password = password;
            }
            
            // Handle email change
            if (email !== editingUserEmail) {
                user.email = email;
                users[email] = user;
                delete users[editingUserEmail];
                
                // Update current user if editing self
                if (currentUser.email === editingUserEmail) {
                    currentUser.email = email;
                    currentUser.name = name;
                    currentUser.roles = roles;
                    currentUser.permissions = permissions;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('current-user').textContent = `Welcome, ${name}`;
                    updateNavPermissions();
                }
            }
            
            savePersistentData();
            updateUsersTable();
            updateAgentsDisplay();
            closeEditUserModal();
            alert('User updated successfully!');
        }
        
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            editingUserEmail = null;
        }
        
        function updateAgentsDisplay() {
            const grid = document.getElementById('agents-grid');
            grid.innerHTML = '<div class="agent-card active" onclick="showAgentStats(\'Riley\')" style="cursor: pointer;"><strong>Riley</strong><br><small>AI Bot (Default)</small><br><small>0 conversations</small></div>';
            
            // Get users who can act as agents (Agent, Admin, Super Admin)
            const agentUsers = Object.values(users).filter(user => 
                user.roles.some(role => ['Agent', 'Admin', 'Super Admin'].includes(role))
            );
            
            agentUsers.forEach(user => {
                const userConversations = conversations.filter(c => c.assignedTo === user.name).length;
                const roleDisplay = user.roles.includes('Super Admin') ? 'Super Admin' : 
                                  user.roles.includes('Admin') ? 'Admin' : 'Agent';
                
                grid.innerHTML += `
                    <div class="agent-card" onclick="showAgentStats('${user.name}')" style="cursor: pointer;">
                        <strong>${user.name}</strong><br>
                        <small>${roleDisplay}</small><br>
                        <small>${userConversations} conversations</small>
                    </div>
                `;
            });
        }
        
        function showAgentStats(agentName) {
            const agentConversations = conversations.filter(c => c.assignedTo === agentName);
            const activeConversations = agentConversations.filter(c => c.status === 'active').length;
            const convertedConversations = agentConversations.filter(c => c.status === 'converted').length;
            const conversionRate = agentConversations.length > 0 ? Math.round((convertedConversations / agentConversations.length) * 100) : 0;
            
            alert(`${agentName} Stats:\n\nTotal Conversations: ${agentConversations.length}\nActive: ${activeConversations}\nConverted: ${convertedConversations}\nConversion Rate: ${conversionRate}%`);
        }
        
        function addUser() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin permissions required.');
                return;
            }
            
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            
            if (!name || !email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            if (users[email]) {
                alert('User with this email already exists');
                return;
            }
            
            // Get selected roles
            const roles = [];
            if (document.getElementById('role-super-admin').checked) roles.push('Super Admin');
            if (document.getElementById('role-admin').checked) roles.push('Admin');
            if (document.getElementById('role-agent').checked) roles.push('Agent');
            
            // Get selected permissions
            const permissions = [];
            if (document.getElementById('perm-conversations').checked) permissions.push('conversations');
            if (document.getElementById('perm-analytics').checked) permissions.push('analytics');
            if (document.getElementById('perm-lsa').checked) permissions.push('lsa');
            if (document.getElementById('perm-admin').checked) permissions.push('admin');
            
            // Create user object
            users[email] = {
                name: name,
                email: email,
                password: password,
                roles: roles,
                permissions: permissions,
                conversationCount: 0,
                createdAt: new Date().toISOString()
            };
            
            savePersistentData();
            
            // Clear form
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('role-super-admin').checked = false;
            document.getElementById('role-admin').checked = false;
            document.getElementById('role-agent').checked = true;
            document.getElementById('perm-conversations').checked = true;
            document.getElementById('perm-analytics').checked = false;
            document.getElementById('perm-lsa').checked = false;
            document.getElementById('perm-admin').checked = false;
            
            updateUsersTable();
            alert('User added successfully!');
        }
        
        function updateUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            Object.values(users).forEach(user => {
                const rolesBadges = user.roles.map(role => {
                    const roleClass = role.toLowerCase().replace(' ', '-');
                    return `<span class="role-badge role-${roleClass}">${role}</span>`;
                }).join('');
                
                const permissionsText = user.permissions.join(', ');
                
                tbody.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${rolesBadges}</td>
                        <td>${permissionsText}</td>
                        <td>
                            <button class="btn btn-warning" style="font-size: 0.8em; padding: 4px 8px; margin-right: 5px;" onclick="editUser('${user.email}')">Edit</button>
                            <button class="btn btn-danger" style="font-size: 0.8em; padding: 4px 8px;" onclick="deleteUser('${user.email}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function deleteUser(email) {
            if (email === currentUser.email) {
                alert('Cannot delete your own account');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user ${email}?`)) {
                delete users[email];
                savePersistentData();
                updateUsersTable();
            }
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('modal-messages');
            if (!messages || messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No messages yet</p>';
                return;
            }
            
            const customerName = document.getElementById('modal-name').value || 'Customer';
            
            container.innerHTML = messages.map(msg => {
                const messageClass = msg.sender === 'user' ? 'message-user' : 
                                   msg.sender === 'admin' ? 'message-admin' : 'message-bot';
                const timestamp = new Date(msg.timestamp).toLocaleString();
                
                let senderName = 'Riley';
                if (msg.sender === 'user') {
                    senderName = customerName;
                } else if (msg.sender === 'admin') {
                    // Find user by sentBy field or use generic Admin
                    if (msg.sentBy) {
                        senderName = msg.sentBy;
                    } else {
                        // Try to find user by looking up who took over or assigned
                        const conversation = conversations.find(c => c.phone === document.getElementById('modal-phone').value);
                        if (conversation && conversation.takenOverBy) {
                            const user = Object.values(users).find(u => u.email === conversation.takenOverBy);
                            senderName = user ? user.name : 'Admin';
                        } else {
                            senderName = 'Admin';
                        }
                    }
                }
                
                return `
                    <div class="message-item ${messageClass}">
                        <strong>${senderName}:</strong>
                        ${msg.text}<br>
                        <small style="color: #666;">${timestamp}</small>
                    </div>
                `;
            }).join('');
            
            // Auto-scroll to newest message
            container.scrollTop = container.scrollHeight;
        }
        
        function saveContact() {
            const phone = document.getElementById('modal-phone').value;
            const name = document.getElementById('modal-name').value;
            const status = document.getElementById('modal-status').value;
            const assigned = document.getElementById('modal-assigned').value;
            const notes = document.getElementById('modal-notes').value;
            
            // Find and update conversation
            const conversation = conversations.find(c => c.phone === phone);
            if (conversation) {
                conversation.name = name;
                conversation.status = status;
                conversation.assignedTo = assigned;
                conversation.notes = notes;
                conversation.lastUpdated = new Date().toISOString();
                
                // Add/update contact profile
                if (name && name.trim()) {
                    contacts[phone] = {
                        name: name,
                        phone: phone,
                        status: status,
                        assignedTo: assigned,
                        notes: notes,
                        messages: conversation.messages || [],
                        firstContact: conversation.timestamp,
                        lastUpdated: new Date().toISOString(),
                        conversationCount: 1
                    };
                    savePersistentData();
                    updateContactsDisplay();
                }
                
                // Save conversations to localStorage
                localStorage.setItem('rileyConversations', JSON.stringify(conversations));
                
                // Update display
                updateKanbanBoard();
                closeModal();
            }
        }
        
        function archiveConversation() {
            const phone = document.getElementById('modal-phone').value;
            const conversationIndex = conversations.findIndex(c => c.phone === phone);
            
            if (conversationIndex !== -1) {
                conversations[conversationIndex].status = 'archived';
                conversations[conversationIndex].archivedAt = new Date().toISOString();
                
                // Keep contact profile but mark as archived
                if (contacts[phone]) {
                    contacts[phone].status = 'archived';
                    contacts[phone].archivedAt = new Date().toISOString();
                    savePersistentData();
                }
                
                updateKanbanBoard();
                updateContactsDisplay();
                closeModal();
            }
        }
        
        function deleteConversation() {
            const phone = document.getElementById('modal-phone').value;
            const conversationIndex = conversations.findIndex(c => c.phone === phone);
            
            if (conversationIndex !== -1 && confirm('Are you sure you want to delete this conversation?')) {
                conversations.splice(conversationIndex, 1);
                
                // Remove from contacts as well
                if (contacts[phone]) {
                    delete contacts[phone];
                    savePersistentData();
                }
                
                updateKanbanBoard();
                updateContactsDisplay();
                closeModal();
            }
        }
        
        function takeOverConversation() {
            const phone = document.getElementById('modal-phone').value;
            const conversation = conversations.find(c => c.phone === phone);
            
            if (conversation) {
                conversation.assignedTo = currentUser.name;
                conversation.takenOverBy = currentUser.email;
                conversation.takenOverAt = new Date().toISOString();
                
                // Add system message
                if (!conversation.messages) conversation.messages = [];
                conversation.messages.push({
                    sender: 'admin',
                    text: `Conversation taken over by ${currentUser.name}`,
                    timestamp: new Date().toISOString()
                });
                
                document.getElementById('modal-assigned').value = currentUser.name;
                displayMessages(conversation.messages);
                updateKanbanBoard();
                alert('Conversation taken over successfully!');
            }
        }
        
        function sendAdminMessage() {
            const phone = document.getElementById('modal-phone').value;
            const messageText = document.getElementById('admin-message').value;
            
            if (!messageText.trim()) {
                alert('Please enter a message');
                return;
            }
            
            const conversation = conversations.find(c => c.phone === phone);
            if (conversation) {
                if (!conversation.messages) conversation.messages = [];
                
                const newMessage = {
                    sender: 'admin',
                    text: messageText,
                    timestamp: new Date().toISOString(),
                    sentBy: currentUser.name
                };
                
                conversation.messages.push(newMessage);
                document.getElementById('admin-message').value = '';
                displayMessages(conversation.messages);
                
                // In real app, would send SMS via Twilio
            }
        }
        
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendAdminMessage();
            }
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Load page-specific data
            if (pageId === 'analytics') {
                updateAnalytics();
            } else if (pageId === 'admin') {
                updateUsersTable();
                updateAgentsDisplay();
            } else if (pageId === 'contacts') {
                updateContactsDisplay();
            } else if (pageId === 'google-lsa') {
                loadLSAData();
            }
        }
        
        function loadLSAData() {
            document.getElementById('lsa-connection-status').textContent = 'Connected to 8 Panda Exteriors locations across 5 states';
            loadLSALeads();
        }
        
        function loadLSALeads() {
            // Load LSA leads from Google Sheets via Apps Script
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbysMA3v3qswUyVdJ1x4Dwe1gpXlU4pzcNqPbE_BBP0DCgcE6yqR-DdxELIh-JUVJKFF/exec';
            
            fetch(scriptUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('LSA leads loaded:', data);
                    populateLSALeads(data);
                })
                .catch(error => {
                    console.log('Using demo LSA data');
                    // Demo data for testing
                    const demoData = [
                        {
                            date: '2025-08-28',
                            customer: 'John Smith',
                            phone: '+1234567890',
                            service: 'Roof Repair',
                            location: 'Laurel, MD',
                            status: 'Qualified',
                            duration: '3:45'
                        },
                        {
                            date: '2025-08-28',
                            customer: 'Sarah Johnson',
                            phone: '+1987654321',
                            service: 'Siding Installation',
                            location: 'Tampa, FL',
                            status: 'New',
                            duration: '2:15'
                        },
                        {
                            date: '2025-08-27',
                            customer: 'Mike Wilson',
                            phone: '+1555123456',
                            service: 'Gutter Cleaning',
                            location: 'King of Prussia, PA',
                            status: 'Converted',
                            duration: '4:20'
                        }
                    ];
                    populateLSALeads(demoData);
                });
        }
        
        function populateLSALeads(leads) {
            // Populate rollup table
            const rollupTbody = document.getElementById('rollup-leads-tbody');
            rollupTbody.innerHTML = leads.map(lead => `
                <tr>
                    <td>${lead.date}</td>
                    <td>${lead.customer}</td>
                    <td>${lead.phone}</td>
                    <td>${lead.service}</td>
                    <td>${lead.location}</td>
                    <td><span class="status-badge status-${lead.status.toLowerCase()}">${lead.status}</span></td>
                    <td>${lead.duration}</td>
                </tr>
            `).join('');
            
            // Populate Maryland table (filter by MD)
            const marylandLeads = leads.filter(lead => lead.location.includes('MD'));
            const marylandTbody = document.getElementById('maryland-leads-tbody');
            if (marylandLeads.length > 0) {
                marylandTbody.innerHTML = marylandLeads.map(lead => `
                    <tr>
                        <td>${lead.date}</td>
                        <td>${lead.customer}</td>
                        <td>${lead.phone}</td>
                        <td>${lead.service}</td>
                        <td>${lead.location}</td>
                        <td><span class="status-badge status-${lead.status.toLowerCase()}">${lead.status}</span></td>
                        <td>${lead.duration}</td>
                    </tr>
                `).join('');
            } else {
                marylandTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No Maryland leads found</td></tr>';
            }
        }
        
        function showLSATab(tabName) {
            // Hide all LSA tab contents
            document.querySelectorAll('.lsa-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all LSA nav items
            document.querySelectorAll('#lsa-tabs .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`lsa-${tabName}`).style.display = 'block';
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
        }
        
        function updateContactsDisplay() {
            const grid = document.getElementById('contacts-grid');
            const contactsArray = Object.values(contacts).filter(c => c.status !== 'archived');
            
            if (contactsArray.length === 0) {
                grid.innerHTML = '<div class="agent-card"><strong>No Contacts</strong><br><small>Contacts will appear here as conversations are processed</small></div>';
                return;
            }
            
            grid.innerHTML = contactsArray.map(contact => `
                <div class="agent-card" onclick="openContactProfile('${contact.phone}')" style="cursor: pointer;">
                    <strong>${contact.name}</strong><br>
                    <small>${contact.phone}</small><br>
                    <small>Status: ${contact.status}</small><br>
                    <small>Messages: ${contact.messages ? contact.messages.length : 0}</small>
                </div>
            `).join('');
        }
        
        function searchContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();
            const contactsArray = Object.values(contacts).filter(c => 
                c.status !== 'archived' && 
                (c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm))
            );
            
            const grid = document.getElementById('contacts-grid');
            if (contactsArray.length === 0) {
                grid.innerHTML = '<div class="agent-card"><strong>No Matches</strong><br><small>No contacts match your search</small></div>';
                return;
            }
            
            grid.innerHTML = contactsArray.map(contact => `
                <div class="agent-card" onclick="openContactProfile('${contact.phone}')" style="cursor: pointer;">
                    <strong>${contact.name}</strong><br>
                    <small>${contact.phone}</small><br>
                    <small>Status: ${contact.status}</small><br>
                    <small>Messages: ${contact.messages ? contact.messages.length : 0}</small>
                </div>
            `).join('');
        }
        
        function openContactProfile(phone) {
            const contact = contacts[phone];
            if (contact) {
                // Find the conversation and open it
                const conversation = conversations.find(c => c.phone === phone);
                if (conversation) {
                    openConversation(conversation);
                }
            }
        }
        
        function loadData() {
            loadPersistentData();
            // Load live conversations from Twilio webhook
            loadLiveConversations();
            // Simulate loading conversations from API
            setTimeout(() => {
                updateKanbanBoard();
                updateAgentsDisplay();
                updateAssignedDropdown();
                updateContactsDisplay();
                updateUsersTable();
            }, 1000);
        }
        
        function loadLiveConversations() {
            // Poll for new conversations from S3 bucket
            // Use relative path for same-origin request, or API endpoint for live data
            fetch('./conversations.json?t=' + Date.now())
                .then(response => {
                    console.log('Conversations fetch response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded conversations data:', data);
                    if (data && data.conversations && data.conversations.length > 0) {
                        // Merge new conversations with existing ones
                        data.conversations.forEach(newConv => {
                            const existingIndex = conversations.findIndex(c => c.phone === newConv.phone);
                            if (existingIndex === -1) {
                                // New conversation
                                console.log('Adding new conversation:', newConv.phone);
                                conversations.push({
                                    ...newConv,
                                    status: 'active',
                                    assignedTo: 'Riley',
                                    timestamp: new Date().toISOString()
                                });
                            } else {
                                // Update existing conversation with new messages
                                if (newConv.messages && newConv.messages.length > conversations[existingIndex].messages.length) {
                                    conversations[existingIndex].messages = newConv.messages;
                                    conversations[existingIndex].lastUpdated = new Date().toISOString();
                                }
                            }
                        });
                        savePersistentData();
                        updateKanbanBoard();
                    }
                })
                .catch(error => {
                    console.log('Error loading conversations:', error);
                });
        }
        
        function refreshData() {
            loadData();
        }
        
        // Auto-refresh every 30 seconds for new conversations
        setInterval(loadLiveConversations, 30000);
        
        // Auto-refresh LSA data every 5 minutes
        setInterval(loadLSALeads, 5 * 60 * 1000);
        
        function updateKanbanBoard() {
            // Simulate conversation data
            if (conversations.length === 0) {
                conversations = [
                    {
                        phone: '+1234567890',
                        name: 'John Smith',
                        status: 'active',
                        assignedTo: 'Riley',
                        timestamp: new Date().toISOString(),
                        messages: [
                            { sender: 'user', text: 'Hi, I need help with my roof', timestamp: new Date().toISOString() },
                            { sender: 'bot', text: 'Hello! I can help you with roofing services. What type of issue are you experiencing?', timestamp: new Date().toISOString() }
                        ]
                    },
                    {
                        phone: '+1987654321',
                        name: 'Sarah Johnson',
                        status: 'contacted',
                        assignedTo: 'Riley',
                        timestamp: new Date().toISOString(),
                        messages: [
                            { sender: 'user', text: 'Need siding repair', timestamp: new Date().toISOString() },
                            { sender: 'bot', text: 'I can help with siding repairs. What area needs attention?', timestamp: new Date().toISOString() }
                        ]
                    }
                ];
            }
            
            const statusCounts = { active: 0, contacted: 0, qualified: 0, converted: 0, archived: 0 };
            
            ['active', 'contacted', 'qualified', 'converted', 'archived'].forEach(status => {
                const statusConversations = conversations.filter(c => c.status === status);
                statusCounts[status] = statusConversations.length;
                
                const listElement = document.getElementById(`${status}-conversations-list`);
                if (statusConversations.length === 0) {
                    listElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No conversations</p>';
                } else {
                    listElement.innerHTML = statusConversations.map((conv, index) => `
                        <div class="conversation-card" draggable="true" 
                             ondragstart="dragStart(event, '${conv.phone}')" 
                             onclick="openConversation(${JSON.stringify(conv).replace(/"/g, '&quot;')})">
                            <div class="customer-name">${conv.name || 'Unknown Customer'}</div>
                            <div class="phone">${conv.phone}</div>
                            <div style="font-size: 0.8em; color: #888;">Assigned to: ${conv.assignedTo}</div>
                        </div>
                    `).join('');
                }
                
                document.getElementById(`${status}-count`).textContent = statusCounts[status];
            });
            
            // Add drag and drop event listeners
            setupDragAndDrop();
        }
        
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        function dragStart(event, phone) {
            event.dataTransfer.setData('text/plain', phone);
            event.target.classList.add('dragging');
        }
        
        function handleDragOver(event) {
            event.preventDefault();
        }
        
        function handleDragEnter(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            const phone = event.dataTransfer.getData('text/plain');
            const newStatus = event.currentTarget.getAttribute('data-status');
            
            // Find and update conversation
            const conversation = conversations.find(c => c.phone === phone);
            if (conversation && conversation.status !== newStatus) {
                conversation.status = newStatus;
                conversation.lastUpdated = new Date().toISOString();
                
                // Update contact if exists
                if (contacts[phone]) {
                    contacts[phone].status = newStatus;
                    savePersistentData();
                }
                
                // Save conversations to localStorage
                localStorage.setItem('rileyConversations', JSON.stringify(conversations));
                
                updateKanbanBoard();
            }
            
            // Clean up drag styles
            event.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.conversation-card').forEach(card => {
                card.classList.remove('dragging');
            });
        }
        
        function openConversation(conversation) {
            document.getElementById('modal-name').value = conversation.name || '';
            document.getElementById('modal-phone').value = conversation.phone;
            document.getElementById('modal-status').value = conversation.status;
            document.getElementById('modal-assigned').value = conversation.assignedTo;
            document.getElementById('modal-notes').value = conversation.notes || '';
            
            displayMessages(conversation.messages);
            
            document.getElementById('conversationModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('conversationModal').style.display = 'none';
        }
        
        function updateAssignedDropdown() {
            const select = document.getElementById('modal-assigned');
            select.innerHTML = agents.map(agent => 
                `<option value="${agent}">${agent}${agent === 'Riley' ? ' (AI Bot)' : ''}</option>`
            ).join('');
        }
        
        function updateAnalytics() {
            const total = conversations.length;
            const active = conversations.filter(c => c.status === 'active').length;
            const converted = conversations.filter(c => c.status === 'converted').length;
            const rate = total > 0 ? Math.round((converted / total) * 100) : 0;
            
            document.getElementById('analytics-total').textContent = total;
            document.getElementById('analytics-active').textContent = active;
            document.getElementById('analytics-converted').textContent = converted;
            document.getElementById('analytics-rate').textContent = rate + '%';
        }
        
        // Modal close functionality
        document.querySelector('.close').onclick = closeModal;
        window.onclick = function(event) {
            if (event.target == document.getElementById('conversationModal')) {
                closeModal();
            }
            if (event.target == document.getElementById('editUserModal')) {
                closeEditUserModal();
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            if (!checkSession()) {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });
        
        // Twilio webhook handler for real-time SMS
        function handleTwilioWebhook(data) {
            const newConversation = {
                phone: data.From,
                name: data.ProfileName || 'Unknown Customer',
                status: 'active',
                assignedTo: 'Riley',
                timestamp: new Date().toISOString(),
                messages: [{
                    sender: 'user',
                    text: data.Body,
                    timestamp: new Date().toISOString()
                }]
            };
            
            const existingIndex = conversations.findIndex(c => c.phone === data.From);
            if (existingIndex === -1) {
                conversations.push(newConversation);
            } else {
                conversations[existingIndex].messages.push({
                    sender: 'user',
                    text: data.Body,
                    timestamp: new Date().toISOString()
                });
                conversations[existingIndex].lastUpdated = new Date().toISOString();
            }
            
            savePersistentData();
            updateKanbanBoard();
        }
    </script>
</body>
</html>