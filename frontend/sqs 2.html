<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riley SMS Dashboard - SQS Real-time</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #28a745; }
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .kanban-column { background: white; border-radius: 8px; padding: 20px; min-height: 400px; }
        .column-header { font-weight: 600; padding: 10px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; text-align: center; }
        .conversation-card { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px; }
        .conversation-card.new { border-left: 4px solid #007bff; background: #e7f3ff; }
        .customer-name { font-weight: 600; color: #007bff; margin-bottom: 5px; }
        .phone { color: #666; font-size: 0.9em; margin-bottom: 5px; }
        .message { color: #333; font-size: 0.9em; margin: 8px 0; }
        .timestamp { color: #888; font-size: 0.8em; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“± Riley SMS Dashboard - Real-time SQS</h1>
            <p>Live SMS messages from mobile devices via Amazon SQS</p>
        </div>

        <div class="status" id="status">
            âœ… Connected to SQS - Polling for new messages every 5 seconds
        </div>

        <div class="kanban-board">
            <div class="kanban-column">
                <div class="column-header" style="background: #e3f2fd;">
                    New Leads (<span id="active-count">0</span>)
                </div>
                <div id="active-conversations-list">Waiting for SMS messages...</div>
            </div>
            <div class="kanban-column">
                <div class="column-header" style="background: #fff3e0;">
                    Contacted (<span id="contacted-count">0</span>)
                </div>
                <div id="contacted-conversations-list">No contacted leads</div>
            </div>
            <div class="kanban-column">
                <div class="column-header" style="background: #e8f5e8;">
                    Qualified (<span id="qualified-count">0</span>)
                </div>
                <div id="qualified-conversations-list">No qualified leads</div>
            </div>
            <div class="kanban-column">
                <div class="column-header" style="background: #f3e5f5;">
                    Converted (<span id="converted-count">0</span>)
                </div>
                <div id="converted-conversations-list">No converted leads</div>
            </div>
        </div>
    </div>

    <script>
        const SQS_API_URL = 'https://2i7n2yee6mrnykskhef45j44py0gviur.lambda-url.us-east-1.on.aws/';
        let conversations = [];

        async function pollSQSMessages() {
            try {
                const response = await fetch(SQS_API_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success && data.messages.length > 0) {
                    console.log('New SQS messages:', data.messages);
                    
                    data.messages.forEach(msg => {
                        const existingConv = conversations.find(c => c.phone === msg.phone);
                        
                        if (!existingConv) {
                            conversations.push({
                                id: Date.now() + Math.random(),
                                phone: msg.phone,
                                customerName: msg.customerName,
                                message: msg.message,
                                timestamp: msg.timestamp,
                                status: msg.status,
                                isNew: true
                            });
                        }
                    });
                    
                    updateDisplay();
                    document.getElementById('status').innerHTML = `âœ… Last update: ${new Date().toLocaleTimeString()} - ${data.messages.length} new messages`;
                } else {
                    document.getElementById('status').innerHTML = `ðŸ”„ Polling SQS - Last check: ${new Date().toLocaleTimeString()}`;
                }
                
            } catch (error) {
                console.error('SQS polling error:', error);
                document.getElementById('status').innerHTML = `âŒ SQS connection error: ${error.message}`;
            }
        }

        function updateDisplay() {
            const activeConvs = conversations.filter(c => c.status === 'active');
            const contactedConvs = conversations.filter(c => c.status === 'contacted');
            const qualifiedConvs = conversations.filter(c => c.status === 'qualified');
            const convertedConvs = conversations.filter(c => c.status === 'converted');
            
            document.getElementById('active-count').textContent = activeConvs.length;
            document.getElementById('contacted-count').textContent = contactedConvs.length;
            document.getElementById('qualified-count').textContent = qualifiedConvs.length;
            document.getElementById('converted-count').textContent = convertedConvs.length;
            
            updateConversationList('active-conversations-list', activeConvs);
            updateConversationList('contacted-conversations-list', contactedConvs);
            updateConversationList('qualified-conversations-list', qualifiedConvs);
            updateConversationList('converted-conversations-list', convertedConvs);
        }

        function updateConversationList(containerId, convs) {
            const container = document.getElementById(containerId);
            let html = '';
            
            convs.forEach(conv => {
                const time = new Date(conv.timestamp).toLocaleString();
                const newClass = conv.isNew ? 'new' : '';
                
                html += `
                    <div class="conversation-card ${newClass}">
                        <div class="customer-name">${conv.customerName}</div>
                        <div class="phone">${conv.phone}</div>
                        <div class="message">"${conv.message}"</div>
                        <div class="timestamp">${time}</div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="moveConversation('${conv.id}', 'contacted')">Contact</button>
                            <button class="btn btn-success" onclick="moveConversation('${conv.id}', 'qualified')">Qualify</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div style="text-align: center; color: #666; padding: 20px;">No conversations</div>';
        }

        function moveConversation(convId, newStatus) {
            const conv = conversations.find(c => c.id == convId);
            if (conv) {
                conv.status = newStatus;
                conv.isNew = false;
                updateDisplay();
            }
        }

        // Poll SQS every 5 seconds for real-time updates
        setInterval(pollSQSMessages, 5000);
        
        // Initial load
        pollSQSMessages();
        updateDisplay();
    </script>
</body>
</html>